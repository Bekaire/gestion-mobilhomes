<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Mobil-Homes</title>
    <link rel="manifest" href="/gestion-mobilhomes/manifest.json">
    <meta name="theme-color" content="#16a34a">
    <link rel="apple-touch-icon" href="/gestion-mobilhomes/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .section-header {
            background: linear-gradient(135deg, #16a34a 0%, #059669 100%);
        }
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen pb-20">
        <!-- Header -->
        <header class="section-header text-white p-6 shadow-lg no-print">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl font-bold mb-2">üèïÔ∏è Gestion Mobil-Homes</h1>
                <p class="text-green-100">Suivi et gestion de vos emplacements</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-md sticky top-0 z-10 no-print">
            <div class="max-w-6xl mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto">
                    <button onclick="showTab('dashboard')" 
                            class="tab-btn px-6 py-4 font-medium transition-colors whitespace-nowrap"
                            data-tab="dashboard">
                        üìä Tableau de bord
                    </button>
                    <button onclick="showTab('mobilhomes')" 
                            class="tab-btn px-6 py-4 font-medium transition-colors whitespace-nowrap"
                            data-tab="mobilhomes">
                        üè† Mobil-Homes
                    </button>
                    <button onclick="showTab('occupants')" 
                            class="tab-btn px-6 py-4 font-medium transition-colors whitespace-nowrap"
                            data-tab="occupants">
                        üë• Occupants
                    </button>
                    <button onclick="showTab('settings')" 
                            class="tab-btn px-6 py-4 font-medium transition-colors whitespace-nowrap"
                            data-tab="settings">
                        ‚öôÔ∏è Param√®tres
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto p-4 mt-6">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="stat-card bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Total Mobil-Homes</p>
                                <p id="total-mh" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div class="text-4xl">üè†</div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Occup√©s</p>
                                <p id="occupied-mh" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="text-4xl">‚úÖ</div>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Disponibles</p>
                                <p id="available-mh" class="text-3xl font-bold text-orange-600">0</p>
                            </div>
                            <div class="text-4xl">üîì</div>
                        </div>
                    </div>
                </div>

                <!-- Liste des Mobil-Homes -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">√âtat des emplacements</h2>
                    <div id="dashboard-list" class="space-y-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Mobil-Homes Tab -->
            <div id="mobilhomes-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Gestion des Mobil-Homes</h2>
                        <button onclick="showAddMHForm()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ‚ûï Ajouter
                        </button>
                    </div>
                    
                    <!-- Add MH Form -->
                    <div id="add-mh-form" class="hidden mb-6 p-4 bg-green-50 rounded-lg">
                        <h3 class="font-bold mb-3">Nouveau Mobil-Home</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="mh-numero" placeholder="Num√©ro" 
                                   class="border rounded-lg px-4 py-2">
                            <input type="text" id="mh-emplacement" placeholder="Emplacement" 
                                   class="border rounded-lg px-4 py-2">
                            <input type="text" id="mh-modele" placeholder="Mod√®le" 
                                   class="border rounded-lg px-4 py-2">
                            <input type="number" id="mh-annee" placeholder="Ann√©e" 
                                   class="border rounded-lg px-4 py-2">
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="saveMH()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                Enregistrer
                            </button>
                            <button onclick="hideAddMHForm()" 
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg">
                                Annuler
                            </button>
                        </div>
                    </div>
                    
                    <div id="mh-list" class="space-y-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Occupants Tab -->
            <div id="occupants-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Gestion des Occupants</h2>
                        <button onclick="showAddOccupantForm()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ‚ûï Ajouter
                        </button>
                    </div>
                    
                    <!-- Add Occupant Form -->
                    <div id="add-occupant-form" class="hidden mb-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-bold mb-3">Nouvel Occupant</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="occ-nom" placeholder="Nom" 
                                   class="border rounded-lg px-4 py-2">
                            <input type="text" id="occ-prenom" placeholder="Pr√©nom" 
                                   class="border rounded-lg px-4 py-2">
                            <input type="tel" id="occ-telephone" placeholder="T√©l√©phone" 
                                   class="border rounded-lg px-4 py-2">
                            <input type="email" id="occ-email" placeholder="Email" 
                                   class="border rounded-lg px-4 py-2">
                            <select id="occ-mh" class="border rounded-lg px-4 py-2">
                                <option value="">S√©lectionner un Mobil-Home</option>
                            </select>
                            <input type="date" id="occ-date-entree" 
                                   class="border rounded-lg px-4 py-2">
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="saveOccupant()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                                Enregistrer
                            </button>
                            <button onclick="hideAddOccupantForm()" 
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg">
                                Annuler
                            </button>
                        </div>
                    </div>
                    
                    <div id="occupant-list" class="space-y-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">Param√®tres et Donn√©es</h2>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-yellow-50 rounded-lg">
                            <h3 class="font-bold mb-2">‚ö†Ô∏è Zone de danger</h3>
                            <p class="text-sm text-gray-600 mb-3">
                                Cette action supprimera toutes les donn√©es de l'application.
                            </p>
                            <button onclick="clearAllData()" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg">
                                Effacer toutes les donn√©es
                            </button>
                        </div>
                        
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-bold mb-2">üíæ Export des donn√©es</h3>
                            <p class="text-sm text-gray-600 mb-3">
                                T√©l√©chargez vos donn√©es au format JSON.
                            </p>
                            <button onclick="exportData()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                                Exporter les donn√©es
                            </button>
                        </div>
                        
                        <div class="p-4 bg-green-50 rounded-lg">
                            <h3 class="font-bold mb-2">üì• Import des donn√©es</h3>
                            <p class="text-sm text-gray-600 mb-3">
                                Importez des donn√©es depuis un fichier JSON.
                            </p>
                            <input type="file" id="import-file" accept=".json" class="mb-2">
                            <button onclick="importData()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                Importer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Data Storage
        let mobilhomes = JSON.parse(localStorage.getItem('mobilhomes')) || [];
        let occupants = JSON.parse(localStorage.getItem('occupants')) || [];

        // Initialize App
        function init() {
            showTab('dashboard');
            updateDashboard();
            renderMHList();
            renderOccupantList();
            updateMHSelect();
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('border-b-4', 'border-green-600', 'text-green-600');
                } else {
                    btn.classList.remove('border-b-4', 'border-green-600', 'text-green-600');
                    btn.classList.add('text-gray-600');
                }
            });
        }

        // Dashboard Functions
        function updateDashboard() {
            const total = mobilhomes.length;
            const occupied = mobilhomes.filter(mh => 
                occupants.some(occ => occ.mobilhomeId === mh.id)
            ).length;
            const available = total - occupied;

            document.getElementById('total-mh').textContent = total;
            document.getElementById('occupied-mh').textContent = occupied;
            document.getElementById('available-mh').textContent = available;

            renderDashboardList();
        }

        function renderDashboardList() {
            const container = document.getElementById('dashboard-list');
            
            if (mobilhomes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Aucun mobil-home enregistr√©</p>';
                return;
            }

            container.innerHTML = mobilhomes.map(mh => {
                const occupant = occupants.find(occ => occ.mobilhomeId === mh.id);
                const isOccupied = !!occupant;
                
                return `
                    <div class="flex items-center justify-between p-4 border rounded-lg ${isOccupied ? 'bg-blue-50 border-blue-200' : 'bg-orange-50 border-orange-200'}">
                        <div>
                            <div class="font-bold">${mh.numero} - ${mh.emplacement}</div>
                            ${isOccupied ? `<div class="text-sm text-gray-600">üë§ ${occupant.nom} ${occupant.prenom}</div>` : ''}
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm ${isOccupied ? 'bg-blue-200 text-blue-800' : 'bg-orange-200 text-orange-800'}">
                            ${isOccupied ? '‚úÖ Occup√©' : 'üîì Disponible'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        // Mobil-Home Functions
        function showAddMHForm() {
            document.getElementById('add-mh-form').classList.remove('hidden');
        }

        function hideAddMHForm() {
            document.getElementById('add-mh-form').classList.add('hidden');
            clearMHForm();
        }

        function clearMHForm() {
            document.getElementById('mh-numero').value = '';
            document.getElementById('mh-emplacement').value = '';
            document.getElementById('mh-modele').value = '';
            document.getElementById('mh-annee').value = '';
        }

        function saveMH() {
            const numero = document.getElementById('mh-numero').value.trim();
            const emplacement = document.getElementById('mh-emplacement').value.trim();
            const modele = document.getElementById('mh-modele').value.trim();
            const annee = document.getElementById('mh-annee').value.trim();

            if (!numero || !emplacement) {
                alert('Le num√©ro et l\'emplacement sont obligatoires');
                return;
            }

            const newMH = {
                id: Date.now().toString(),
                numero,
                emplacement,
                modele,
                annee
            };

            mobilhomes.push(newMH);
            localStorage.setItem('mobilhomes', JSON.stringify(mobilhomes));
            
            hideAddMHForm();
            renderMHList();
            updateDashboard();
            updateMHSelect();
        }

        function renderMHList() {
            const container = document.getElementById('mh-list');
            
            if (mobilhomes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Aucun mobil-home enregistr√©</p>';
                return;
            }

            container.innerHTML = mobilhomes.map(mh => `
                <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                    <div>
                        <div class="font-bold">${mh.numero} - ${mh.emplacement}</div>
                        <div class="text-sm text-gray-600">${mh.modele || 'N/A'} ${mh.annee ? `(${mh.annee})` : ''}</div>
                    </div>
                    <button onclick="deleteMH('${mh.id}')" 
                            class="text-red-600 hover:text-red-800 px-3 py-1">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function deleteMH(id) {
            if (!confirm('Supprimer ce mobil-home ?')) return;
            
            mobilhomes = mobilhomes.filter(mh => mh.id !== id);
            localStorage.setItem('mobilhomes', JSON.stringify(mobilhomes));
            
            renderMHList();
            updateDashboard();
            updateMHSelect();
        }

        // Occupant Functions
        function showAddOccupantForm() {
            document.getElementById('add-occupant-form').classList.remove('hidden');
        }

        function hideAddOccupantForm() {
            document.getElementById('add-occupant-form').classList.add('hidden');
            clearOccupantForm();
        }

        function clearOccupantForm() {
            document.getElementById('occ-nom').value = '';
            document.getElementById('occ-prenom').value = '';
            document.getElementById('occ-telephone').value = '';
            document.getElementById('occ-email').value = '';
            document.getElementById('occ-mh').value = '';
            document.getElementById('occ-date-entree').value = '';
        }

        function saveOccupant() {
            const nom = document.getElementById('occ-nom').value.trim();
            const prenom = document.getElementById('occ-prenom').value.trim();
            const telephone = document.getElementById('occ-telephone').value.trim();
            const email = document.getElementById('occ-email').value.trim();
            const mobilhomeId = document.getElementById('occ-mh').value;
            const dateEntree = document.getElementById('occ-date-entree').value;

            if (!nom || !prenom || !mobilhomeId) {
                alert('Le nom, pr√©nom et mobil-home sont obligatoires');
                return;
            }

            // Check if MH is already occupied
            const existingOccupant = occupants.find(occ => occ.mobilhomeId === mobilhomeId);
            if (existingOccupant) {
                alert('Ce mobil-home est d√©j√† occup√©');
                return;
            }

            const newOccupant = {
                id: Date.now().toString(),
                nom,
                prenom,
                telephone,
                email,
                mobilhomeId,
                dateEntree
            };

            occupants.push(newOccupant);
            localStorage.setItem('occupants', JSON.stringify(occupants));
            
            hideAddOccupantForm();
            renderOccupantList();
            updateDashboard();
        }

        function renderOccupantList() {
            const container = document.getElementById('occupant-list');
            
            if (occupants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Aucun occupant enregistr√©</p>';
                return;
            }

            container.innerHTML = occupants.map(occ => {
                const mh = mobilhomes.find(m => m.id === occ.mobilhomeId);
                return `
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                        <div>
                            <div class="font-bold">${occ.nom} ${occ.prenom}</div>
                            <div class="text-sm text-gray-600">
                                üè† ${mh ? `${mh.numero} - ${mh.emplacement}` : 'N/A'}
                            </div>
                            ${occ.telephone ? `<div class="text-sm text-gray-600">üìû ${occ.telephone}</div>` : ''}
                            ${occ.email ? `<div class="text-sm text-gray-600">üìß ${occ.email}</div>` : ''}
                        </div>
                        <button onclick="deleteOccupant('${occ.id}')" 
                                class="text-red-600 hover:text-red-800 px-3 py-1">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        function deleteOccupant(id) {
            if (!confirm('Supprimer cet occupant ?')) return;
            
            occupants = occupants.filter(occ => occ.id !== id);
            localStorage.setItem('occupants', JSON.stringify(occupants));
            
            renderOccupantList();
            updateDashboard();
        }

        function updateMHSelect() {
            const select = document.getElementById('occ-mh');
            const availableMH = mobilhomes.filter(mh => 
                !occupants.some(occ => occ.mobilhomeId === mh.id)
            );

            select.innerHTML = '<option value="">S√©lectionner un Mobil-Home</option>' +
                availableMH.map(mh => 
                    `<option value="${mh.id}">${mh.numero} - ${mh.emplacement}</option>`
                ).join('');
        }

        // Settings Functions
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION : Toutes les donn√©es seront supprim√©es d√©finitivement. Continuer ?')) {
                return;
            }
            
            localStorage.clear();
            mobilhomes = [];
            occupants = [];
            
            init();
            alert('‚úÖ Toutes les donn√©es ont √©t√© effac√©es');
        }

        function exportData() {
            const data = {
                mobilhomes,
                occupants,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mobilhomes-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Donn√©es export√©es avec succ√®s');
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Veuillez s√©lectionner un fichier');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.mobilhomes || !data.occupants) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    if (confirm('‚ö†Ô∏è L\'import remplacera toutes les donn√©es actuelles. Continuer ?')) {
                        mobilhomes = data.mobilhomes;
                        occupants = data.occupants;
                        
                        localStorage.setItem('mobilhomes', JSON.stringify(mobilhomes));
                        localStorage.setItem('occupants', JSON.stringify(occupants));
                        
                        init();
                        alert('‚úÖ Donn√©es import√©es avec succ√®s');
                        fileInput.value = '';
                    }
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import : ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Initialize on page load
        init();
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/gestion-mobilhomes/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker enregistr√© avec succ√®s:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Erreur d\'enregistrement du Service Worker:', error);
                    });
            });
        }

        // Install prompt handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('‚úÖ Prompt d\'installation disponible');
        });
    </script>
</body>
</html>
